<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Layer Test</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <script type="importmap">
    {
      "imports": {
        "@india-boundary-corrector/data": "/packages/data/index.js",
        "@india-boundary-corrector/tilefixer": "/packages/tilefixer/dist/index.js",
        "@india-boundary-corrector/layer-configs": "/packages/layer-configs/dist/index.js",
        "@india-boundary-corrector/leaflet-layer": "/packages/leaflet-layer/dist/index.js"
      }
    }
  </script>
  <script type="module">
    import { extendLeaflet, layerConfigs, LayerConfig } from '@india-boundary-corrector/leaflet-layer';
    
    // Extend Leaflet with the corrected tile layer
    extendLeaflet(L);

    // Create a test layer instance
    const testLayer = L.tileLayer.indiaBoundaryCorrected(
      'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
      { layerConfig: 'osm-carto' }
    );

    // Expose package exports for testing
    window.leafletLayerPackage = { layerConfigs, LayerConfig };

    // Mock fetch for testing scenarios
    const originalFetch = window.fetch;
    
    // Create mock tile data (256x256 white PNG)
    const createMockTile = () => {
      const canvas = new OffscreenCanvas(256, 256);
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, 256, 256);
      return canvas.convertToBlob({ type: 'image/png' }).then(blob => blob.arrayBuffer());
    };

    // Mock URL generator
    window.createMockTileUrl = (scenario) => `mock://${scenario}/8/182/101.png`;

    // Override fetch to handle mock URLs
    window.fetch = function(url, ...args) {
      if (typeof url === 'string' && url.includes('broken.pmtiles')) {
        return Promise.reject(new Error('PMTiles fetch failed: network error'));
      }
      
      if (typeof url === 'string' && url.startsWith('mock://')) {
        return createMockTile().then(buffer => ({
          ok: true,
          status: 200,
          arrayBuffer: () => Promise.resolve(buffer)
        }));
      }
      
      return originalFetch(url, ...args);
    };

    // Expose for testing
    window.L = L;
    window.testLayer = testLayer;
    window.leafletLayerLoaded = true;
  </script>
</body>
</html>
